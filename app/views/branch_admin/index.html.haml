%h2
  = @group.name
  = @group.is_conference_group? ? "Registrants" : "Members"

=link_to_unless_current "Current Members", branch_admin_path(params[:group_id])
%br
-if params[:group_id].to_i == NzffaSettings.fft_marketplace_group_id
  =link_to_unless_current "Past FFT members", branch_admin_past_fft_members_path
-elsif !@group.is_conference_group?
  =link_to_unless_current "Past Members - all", branch_admin_past_members_path(params[:group_id])
  %br
  =link_to_unless_current "Past Members - last year only", branch_admin_last_year_members_path(params[:group_id])
%br

=link_to "Email current members", branch_admin_email_path(params[:group_id])
%br

%p
  Download spreadsheet as 
  = link_to "CSV (Comma seperated values)", url_for(:format => :csv)
  or as 
  = link_to "XLS (for Excel)", url_for(:format => :xls)

%br
- if @group.is_conference_group?
  Download all conference subscriptions (not just this group) as
  = link_to "CSV", url_for(:controller => :conference_subscriptions, :action => :index, :format => :csv)
  or as
  = link_to "XLS", url_for(:controller => :conference_subscriptions, :action => :index, :format => :xls)
  
  %br
  = link_to "Find a member to register for the conference", :invite_conference_subscriptions
  
%table{:class => 'px1'}
  %thead
    %th nzffa id
    %th Name
    %th Email
    %th{:style => 'width: 100px'} Phone
    %th Address
    - if @group.is_conference_group?
      %th Registered for
      %th Paid by
      %th Date paid
      %th # Reg.
      %th Levy
      %th Notes
    %th Edit
  %tbody
    -@readers.sort {|a,b| a.surname.to_s <=> b.surname.to_s }.each do |reader|
      - if reader.conference_subscription && (!reader.conference_subscription.couple? || reader.conference_subscription.group_ids.map(&:to_i).include?(@group.id))
        %tr
          %td=reader.nzffa_membership_id
          %td=reader.name
          %td=reader.email
          %td
            =raw [reader.phone, reader.mobile].select{|f| f.present?}.join('<br>')
          %td
            =raw reader.postal_address_array.select{|f| f.present?}.join('<br>')
          - if @group.is_conference_group?
            %td=reader.groups.select{|g| g.ancestors.include?(conference_group)}.map{|g| link_to g.name, branch_admin_path(g)}.join ", "
            - if reader.conference_subscription
              %td= reader.conference_subscription.payment_method
              %td= reader.conference_subscription.paid_at.try(:strftime, "%d %B %H:%M")
              %td= reader.conference_subscription.single_or_couple == 'couple' ? 2 : 1
              %td= number_to_currency reader.conference_subscription.levy
              %td= reader.conference_subscription.notes
            - else
              %td{:colspan => 5} "Not subscribed"
          %td
            =link_to('Edit', branch_admin_edit_path(params[:group_id], reader.nzffa_membership_id))
            - if @group.is_conference_group? && reader.conference_subscription
              = link_to('Delete', conference_subscription_path(reader.conference_subscription.id), :confirm => "There is no way to undo this.. are you REALLY sure you want to delete this conference subscription?", :method => :delete )
              = link_to('Receipt', receipt_conference_subscription_path(reader.conference_subscription.id))
      - if reader.conference_subscription && reader.conference_subscription.couple?
        - if reader.conference_subscription.partner_group_ids.try(:include?, @group.id) || [@group.id, @group.parent_id].include?(Radiant::Config['conference_group_id'].to_i)
          %tr
            %td=reader.nzffa_membership_id
            %td=reader.conference_subscription.partner_name
            %td=reader.email
            %td
              =raw [reader.phone, reader.mobile].select{|f| f.present?}.join('<br>')
            %td
              =raw reader.postal_address_array.select{|f| f.present?}.join('<br>')
            - if @group.is_conference_group?
              %td=reader.groups.select{|g| g.ancestors.include?(conference_group)}.map{|g| link_to g.name, branch_admin_path(g)}.join ", "
              - if reader.conference_subscription
                %td= reader.conference_subscription.payment_method
                %td= reader.conference_subscription.paid_at.try(:strftime, "%d %B %H:%M")
                %td= reader.conference_subscription.single_or_couple == 'couple' ? 2 : 1
                %td= number_to_currency reader.conference_subscription.levy
                %td= reader.conference_subscription.notes
              - else
                %td{:colspan => 5} "Not subscribed"
            %td
              =link_to('Edit', branch_admin_edit_path(params[:group_id], reader.nzffa_membership_id))
              = link_to('Receipt', receipt_conference_subscription_path(reader.conference_subscription.id))
